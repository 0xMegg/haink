"use strict";(()=>{var e={};e.id=684,e.ids=[684],e.modules={399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},4584:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>f,patchFetch:()=>v,requestAsyncStorage:()=>x,routeModule:()=>h,serverHooks:()=>g,staticGenerationAsyncStorage:()=>w});var a={};r.r(a),r.d(a,{GET:()=>_,POST:()=>y});var o=r(3036),n=r(5736),s=r(5262),i=r(942),u=r(5500),l=r(1182),p=r(3513),c=r(3351);class d{async issue(e,t){let r=t.trim();if(!r)throw Error("issued_category_id 가 비어있습니다.");let a=(await e.codeSequenceByCategory.upsert({where:{issued_category_id:r},create:{issued_category_id:r,next_seq:2},update:{next_seq:{increment:1}},select:{next_seq:!0}})).next_seq-1;return{masterCode:`${r}-${a.toString().padStart(5,"0")}`}}}let m=new d;async function _(){let e=await (0,l.t)(50);return i.NextResponse.json({data:e})}async function y(e){try{let t=await e.json(),r=p.kx.parse(t),a=(0,c.i)(r.categoryIdsRaw),o=r.issuedCategoryId??a[0],n=r.currentCategoryId??a[0],s=r.descriptionHtml?.trim()?r.descriptionHtml:null,l=r.saleStatus?.trim()?r.saleStatus:null,d=r.optionName?.trim()?r.optionName:null,_=r.sotMode??"LEGACY_IMWEB",y=r.sourceOfTruth??"IMWEB",h=r.externalUrl?.trim()?r.externalUrl.trim():null,x=function(e){if(!e)return null;try{return JSON.parse(e)}catch{throw Error("rawSnapshot 필드는 올바른 JSON 문자열이어야 합니다.")}}(r.rawSnapshot),w=(r.optionValues??"").split(",").map(e=>e.trim()).filter(Boolean),g=await u._.$transaction(async e=>{if(await e.externalProductMap.findUnique({where:{system_external_id:{system:"IMWEB",external_id:r.productId}}}))throw Error("이미 존재하는 IMWEB 상품입니다.");let{masterCode:t}=await m.issue(e,o);return await e.product.create({data:{master_code:t,name:r.name,issued_category_id:o,current_category_id:n,category_ids_raw:a,price_sale:r.priceSale,inventory_track:r.inventoryTrack,stock_qty:r.inventoryTrack?r.stockQty??null:null,sale_status:l,display_status:r.displayStatus,description_html:s,option_name:d,sot_mode:_,externalProductMaps:{create:{system:"IMWEB",external_id:r.productId,external_url:h,source_of_truth:y,raw_snapshot:x??void 0}},optionValues:w.length>0&&d?{createMany:{data:w.map(e=>({option_name:d,display_value:e,canonical_value:e.toUpperCase()}))}}:void 0},include:{externalProductMaps:!0,optionValues:!0}})});return i.NextResponse.json({data:g},{status:201})}catch(t){let e=t instanceof Error?t.message:"알 수 없는 오류";return i.NextResponse.json({error:e},{status:400})}}let h=new o.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/products/route",pathname:"/api/products",filename:"route",bundlePath:"app/api/products/route"},resolvedPagePath:"/Users/mero/Documents/New project/apps/admin/app/api/products/route.ts",nextConfigOutput:"",userland:a}),{requestAsyncStorage:x,staticGenerationAsyncStorage:w,serverHooks:g}=h,f="/api/products/route";function v(){return(0,s.patchFetch)({serverHooks:g,staticGenerationAsyncStorage:w})}},3351:(e,t,r)=>{r.d(t,{i:()=>a});function a(e){let t=e.split(",").map(e=>e.trim()).filter(Boolean),r=[],a=new Set;for(let e of t)a.has(e)||(a.add(e),r.push(e));if(0===r.length)throw Error("카테고리 ID는 최소 1개 이상이어야 합니다.");return r}},5500:(e,t,r)=>{r.d(t,{_:()=>o});let a=require("@prisma/client"),o=globalThis.prisma??new a.PrismaClient},3513:(e,t,r)=>{r.d(t,{kx:()=>s});var a=r(9763);let o=a.Km(["LEGACY_IMWEB","MASTER"]),n=a.Km(["IMWEB","MASTER"]),s=a.Ry({productId:a.Z_().min(1,"IMWEB 상품번호를 입력하세요."),name:a.Z_().min(1,"상품명을 입력하세요."),categoryIdsRaw:a.Z_().min(1,"카테고리 ID를 입력하세요."),priceSale:a.oQ.number().int().nonnegative("가격은 0 이상이어야 합니다."),inventoryTrack:a.O7(),stockQty:a.oQ.number().int().nonnegative().nullable().optional(),descriptionHtml:a.Z_().optional(),saleStatus:a.Z_().optional(),displayStatus:a.O7(),optionName:a.Z_().optional().nullable(),optionValues:a.Z_().optional(),issuedCategoryId:a.Z_().optional(),currentCategoryId:a.Z_().optional(),sotMode:o.optional(),externalUrl:a.Z_().url("올바른 URL 형식이 아닙니다.").or(a.i0("")).optional(),sourceOfTruth:n.optional(),rawSnapshot:a.Z_().optional()})},1182:(e,t,r)=>{r.d(t,{t:()=>o});var a=r(5500);async function o(e=20){try{return await a._.product.findMany({orderBy:{created_at:"desc"},take:e,include:{externalProductMaps:!0}})}catch(e){return console.warn("상품 목록을 가져오지 못했습니다.",e),[]}}}};var t=require("../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),a=t.X(0,[193,11],()=>r(4584));module.exports=a})();